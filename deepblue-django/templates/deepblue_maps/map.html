{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>DeepBlue Map</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'deepblue_maps/map.css' %}">
    <script async src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=marker&loading=async&callback=initMap"></script>
    <style>
        
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="layer-title">Layer</div>
        <div class="form-check layer-option">
            <input type="checkbox" class="form-check-input" id="local-map" checked>
            <label class="form-check-label" for="local-map">Local Map</label>
        </div>
        <div class="form-check layer-option">
            <input type="checkbox" class="form-check-input" id="dot-map">
            <label class="form-check-label" for="dot-map">Dot Map</label>
        </div>
        <div class="form-check layer-option">
            <input type="checkbox" class="form-check-input" id="heat-map">
            <label class="form-check-label" for="heat-map">Heat Map</label>
        </div>
        <div class="form-check layer-option">
            <input type="checkbox" class="form-check-input" id="seafloor-map">
            <label class="form-check-label" for="seafloor-map">Seafloor Map</label>
        </div>
    </div>

    <div id="map"></div>

    <div class="controls">
        <div>
            <input type="text" id="start-position" placeholder="Start Position" value="47.6061°N, 122.3328°W">
        </div>
        <div>
            <input type="text" id="end-position" placeholder="End Position">
        </div>
        <div>
            <input type="text" id="distance" placeholder="Distance (meters)" readonly>
        </div>
        <div>
            <button id="recordButton" class="recording-inactive" onclick="handleRecord()">Start Recording</button>
        </div>
    </div>

    <script>
        let map;
        let currentMarker = null;
        let centerMarker = null;
        let infoWindow = null;
        let tooltipTimeout = null;
        let connectionLine = null;
        let isRecording = false;

        function initMap() {
            const centerLocation = {lat: 48.544758, lng: -123.012832};
            const centerPinElement = new google.maps.marker.PinElement({
                background: "#4285F4",
                glyphColor: "#FFFFFF"
            });

            map = new google.maps.Map(document.getElementById('map'), {
                center: centerLocation,
                zoom: 20,
                mapTypeId: 'satellite',
                mapId: 'deepblue_map_id'
            });

            // Create info window
            infoWindow = new google.maps.InfoWindow({
                content: "ROV Location"
            });

            // Create blue marker at center
            centerMarker = new google.maps.marker.AdvancedMarkerElement({
                position: centerLocation,
                map: map,
                title: 'Center Location',
                content: centerPinElement.element
            });

            // Add hover listeners
            centerMarker.addListener('mouseover', () => {
                infoWindow.open(map, centerMarker);
            });

            centerMarker.addListener('mouseout', () => {
                infoWindow.close();
            });

            map.addListener('click', function(event) {
                if (!isRecording) {
                    placeMarker(event.latLng);
                    drawConnectionLine(event.latLng);
                }
            });

            // Add input event listener for the end position textbox
            document.getElementById('end-position').addEventListener('change', function() {
                if (!isRecording) {
                    const coords = parseCoordinates(this.value);
                    if (coords) {
                        placeMarker(coords);
                        drawConnectionLine(coords);
                    } else {
                        alert('Invalid coordinates format. Please use format: XX.XXXX°N, XX.XXXX°W');
                    }
                }
            });
        }

        function parseCoordinates(coordString) {
            // Match format like "48.544930°N, -123.014024°W"
            const regex = /^(-?\d+\.?\d*)°([NS]),\s*(-?\d+\.?\d*)°([EW])$/;
            const match = coordString.trim().match(regex);
            
            if (match) {
                let lat = parseFloat(match[1]);
                let lng = parseFloat(match[3]);
                
                // Adjust for S and W hemispheres
                if (match[2] === 'S') lat = -lat;
                if (match[4] === 'W') lng = -lng;
                
                return new google.maps.LatLng(lat, lng);
            }
            return null;
        }

        function drawConnectionLine(endLocation) {
            // Remove existing line if it exists
            if (connectionLine) {
                connectionLine.setMap(null);
            }

            // Create new dotted line
            connectionLine = new google.maps.Polyline({
                path: [
                    centerMarker.position,
                    endLocation
                ],
                geodesic: true,  // Line follows Earth's curvature
                strokeColor: ' #FF0000 ',  // Red color
                strokeOpacity: 0,
                strokeWeight: 2,
                icons: [{
                    icon: {
                        path: 'M 0,-1 0,1',  // Vertical line
                        strokeOpacity: 1,
                        scale: 4
                    },
                    offset: '0',
                    repeat: '15px'  // Space between dots
                }],
                map: map
            });
        }

        function calculateDistance(point1, point2) {
            // Convert latitude and longitude to radians
            const lat1 = point1.lat * Math.PI / 180;
            const lat2 = point2.lat * Math.PI / 180;
            const lon1 = point1.lng * Math.PI / 180;
            const lon2 = point2.lng * Math.PI / 180;
            // Calculate distance using the provided formula
            const distance = Math.acos(
                (Math.sin(lat1) * Math.sin(lat2)) + 
                (Math.cos(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1))
            ) * 6371 * 1000; // Multiply by 6371 km and convert to meters
            return distance;
        }

        function placeMarker(location) {
            if (currentMarker) {
                currentMarker.map = null;
            }

            currentMarker = new google.maps.marker.AdvancedMarkerElement({
                position: location,
                map: map,
                title: 'Selected Location'
            });

            document.getElementById('end-position').value = 
                location.lat().toFixed(6) + '°N, ' + location.lng().toFixed(6) + '°W';
            // Update distance using new formula
            if (centerMarker) {
                const distance = calculateDistance(centerMarker.position, {lat: location.lat(), lng: location.lng()});
                document.getElementById('distance').value = `${distance.toFixed(2)} meters`;
            }
        }

        function handleRecord() {
            const button = document.getElementById('recordButton');
            const endPositionInput = document.getElementById('end-position');
            
            isRecording = !isRecording;
            
            if (isRecording) {
                // Start recording state
                button.textContent = 'Stop';
                button.classList.remove('recording-inactive');
                button.classList.add('recording-active');
                endPositionInput.readOnly = true;
                endPositionInput.style.backgroundColor = '#f8f9fa';
            } else {
                // Stop recording state
                button.textContent = 'Start Recording';
                button.classList.remove('recording-active');
                button.classList.add('recording-inactive');
                endPositionInput.readOnly = false;
                endPositionInput.style.backgroundColor = '';
            }
        }

        // Initialize the map when the page loads
        window.onload = initMap;
    </script>
</body>
</html> 